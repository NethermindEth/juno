name: Juno Benchmarking

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Juno version to benchmark'
        required: true
        default: 'latest'
      snapshot_url:
        description: 'Custom snapshot URL (optional)'
        required: false

jobs:
  juno-benchmark:
    name: EC2 Setup and Juno Launch
    runs-on: ubuntu-latest
    
    env:
      EC2_HOST: "3.126.138.194"
      EC2_USER: "ubuntu"
      SNAPSHOT_URL: "${{ github.event.inputs.snapshot_url || 'https://juno-snapshots.nethermind.io/files/sepolia/latest' }}"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up SSH key for EC2
        env:
          EC2_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          EC2_KEY_PATH="$HOME/.ssh/ec2_key.pem"
          echo "EC2_KEY_PATH=$EC2_KEY_PATH" >> $GITHUB_ENV
          mkdir -p ~/.ssh
          echo "$EC2_PRIVATE_KEY" > "$EC2_KEY_PATH"
          chmod 600 "$EC2_KEY_PATH"
      
      - name: Display configuration
        run: |
          echo "EC2 Host: $EC2_HOST"
          echo "EC2 User: $EC2_USER"
          echo "Juno Version: ${{ github.event.inputs.version }}"
      
      - name: Run EC2 setup script
        run: |
          chmod +x ./scripts/juno-benchmark.sh
          ./scripts/juno-benchmark.sh ${{ github.event.inputs.version }}
      
      - name: Verify Juno is running
        run: |
          sleep 10
          ssh -i "$EC2_KEY_PATH" -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "ps aux | grep juno | grep -v grep"
          echo "Latest Juno log entries:"
          ssh -i "EC2_KEY_PATH" -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "tail -n 30 ~/juno-benchmark/juno.log"

