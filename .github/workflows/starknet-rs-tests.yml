name: starknet-rs tests

on:
  workflow_call:
    inputs:
      ref:
        description: 'The branch, tag or SHA to checkout'
        required: false
        default: 'starknet/v0.12.0'
        type: string
    secrets:
      STARKNET_RPC:
        required: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4
        with:
          repository: xJonathanLEI/starknet-rs
          ref: ${{ inputs.ref }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Run jsonrpc tests
        run: |
          cd starknet-providers && cargo test jsonrpc -- --skip jsonrpc_get_block_with_receipts
          cd ../starknet-accounts && cargo test jsonrpc -- --skip can_declare_cairo0_contract_with_jsonrpc
        env:
          STARKNET_RPC: ${{ secrets.STARKNET_RPC }}
          RUST_BACKTRACE: full
