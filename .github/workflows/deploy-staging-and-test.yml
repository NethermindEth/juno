name: Promote to Staging and Test

on:
  workflow_dispatch:
    inputs:
      docker_image_tag:
        description: 'Docker image tag from Dev to promote'
        required: true
        type: string
      rpc_version:
        description: 'RPC version for tests (e.g., v0_7)'
        required: true
        default: 'v0_7'
        type: string

permissions:
  contents: read

concurrency:
  group: shared_staging_environment
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: nethermind.jfrog.io
  REPO_DEV: nubia-oci-local-dev
  REPO_STAGING: nubia-oci-local-staging

jobs:
  promote_to_staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oras-project/setup-oras@5c0b487ce3fe0ce3ab0d034e63669e426e294e4d

      - name: Login to registry
        run: |
          oras login ${{ env.DOCKER_REGISTRY }} \
            -u ${{ secrets.ARTIFACTORY_NUBIA_USERNAME }} \
            -p ${{ secrets.ARTIFACTORY_NUBIA_TOKEN_DEVELOPER }}

      - name: Check image exists in Dev
        run: |
          oras manifest fetch \
          ${{ env.DOCKER_REGISTRY }}/${{ env.REPO_DEV }}/juno:${{ inputs.docker_image_tag }} || \
          (echo "‚ùå Image not found in Dev!" && exit 1)

      - name: Promote image to Staging
        run: |
          OLD_TAG=${{ env.DOCKER_REGISTRY }}/${{ env.REPO_DEV }}/juno:${{ inputs.docker_image_tag }}
          NEW_TAG=${{ env.DOCKER_REGISTRY }}/${{ env.REPO_STAGING }}/juno:${{ inputs.docker_image_tag }}

          oras cp -r $OLD_TAG $NEW_TAG,latest

      - name: Verify Deployment Version (Staging)
        run: |
          bash .github/workflow-scripts/verify_deployment.sh \
            ${{ secrets.STAGING_SEPOLIA_URL }} \
            ${{ inputs.docker_image_tag }}

  starknet-rs-tests:
    needs: [promote_to_staging]
    uses: ./.github/workflows/starknet-rs-tests.yml
    secrets:
      STARKNET_RPC: ${{ secrets.STAGING_SEPOLIA_URL }}/${{ inputs.rpc_version }}

  starknet-js-tests:
    needs: [promote_to_staging]
    uses: ./.github/workflows/starknet-js-tests.yml
    secrets:
      TEST_RPC_URL: ${{ secrets.STAGING_SEPOLIA_URL }}/${{ inputs.rpc_version }}
      TEST_ACCOUNT_ADDRESS: ${{ secrets.TEST_ACCOUNT_ADDRESS }}
      TEST_ACCOUNT_PRIVATE_KEY: ${{ secrets.TEST_ACCOUNT_PRIVATE_KEY }}

  starknet-go-tests:
    needs: [promote_to_staging]
    uses: ./.github/workflows/starknet-go-tests.yml
    secrets:
      TEST_RPC_URL: ${{ secrets.STAGING_SEPOLIA_URL }}/${{ inputs.rpc_version }}